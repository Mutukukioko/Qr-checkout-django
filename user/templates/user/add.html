{% extends "user/base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}
Cart
{% endblock %}
{% block content %}

<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">


      </div>
    </div><!-- /.container-fluid -->
  </section>
  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-6">
          <div class="card card-teal">
            <div class="card-header " style="justify-content: center;">
              <h3 class="card-title text-bold">Recently Added Products</h3>
              <div class="container"></div>

            </div>
            <!-- /.card-header -->
            {% if cart_items %}
            <div class="card-body p-0">

              <ul class="products-list product-list-in-card pl-2 pr-2">


                {% for cart_item in cart_items %}


                <li class="item">

                  <div class="product-img">
                    <img src="{{ cart_item.product.picture.url }}" alt="Product Image" class="img-size-50">
                  </div>

                  <div class="product-info">
                    <a href="javascript:void(0)" class="product-title">{{ cart_item.product.name }}

                      <span id="cart_money" class="badge badge-warning float-right">Ksh{{
                        cart_item.product.price|floatformat:2|multiply:cart_item.quantity }}</span></a>
                    <span class="product-description">
                      {{cart_item.product.description}}


                    </span> <br>
                    <div class="row">
                      <label class="product-description pr-3 float-left">Quantity :</label>
                      <input type="text" name="quant[2]" class="disabled 0 float-right text-center rounded float-right "
                        readonly value="{{ cart_item.quantity }}" size="1" min="1" max="100">


                      {% if cart_item.barcodes|length > 1 %}
                      <div class="input-group input-group-md mb-3">
                        <div class="input-group-prepend">
                          <button type="button" class="btn btn-warning dropdown-toggle" data-toggle="dropdown">
                            Choose prod barcode to remove
                          </button>
                          <ul class="dropdown-menu">
                            {% for barcode in cart_item.barcodes %}
                            <li> <button type="button" class="btn btn-danger btn-sm me-1 mb-2 remove-item"
                                data-product-id="{{ cart_item.product.name }}" data-barcode-value="{{ barcode }}"
                                title="Remove item">
                                {{ barcode }}
                                <i class="fas fa-trash"></i>
                              </button>
                            </li>
                            {% endfor %}
                          </ul>
                        </div>
                      </div>
                      {% else %}
                      {% for barcode in cart_item.barcodes %}
                      <button type="button" class="btn btn-danger btn-sm me-1 mb-2 remove-item pr-2">

                        <i class="fas fa-trash" data-product-id="{{ cart_item.product.name }}"
                          data-barcode-value="{{ barcode }}" title="Remove item"></i>
                      </button>

                      {% endfor %}
                      {% endif %}

                    </div>
                  </div>

                </li>

                {% endfor %}


              </ul>
            </div>

            {% else %}
            <div class="text-center">
              <img src="{% static 'img/no_cart.png' %}" class="img-fluid" alt="No Cart Items">
              <h5 class="mt-3">Cart is empty</h5>
              <p class="text-muted">Add some items to your cart and start shopping.</p>
            </div>
            {% endif %}
            <!-- /.card-body -->
            <div class="card-footer card-teal bg-gradient-teal " style="inline-size:auto;"></div>
            <!-- /.card-footer -->
          </div>
        </div>
        <div class="col-md-5">
          <!-- Form Element sizes -->
          <div class="card card-teal text-center">
            <div class="card-header text-center" style="justify-content: center; display: flex;">
              <h3 class="card-title text-bold">Total Billing</h3>
            </div>
            <div class="card-body">
              <!-- content ya card hapa -->
              <div class="row">
                <div class="col-4">Total Amount </div>
                <input type="text" class="text-center form-control" id="total_cash" name="total_cash" readonly>
              </div>



              <br>
              <form method="POST" action="{% url 'save_cart' %}">
                {% csrf_token %}
                <button type="submit">Save Cart</button>
              </form>
              <br>
              <div class="button">
                <button type="button" class="btn btn-block bg-gradient-teal btn-flat text-bold" data-toggle="modal"
                  data-target="#modal-lg" style="font-family: 'Times New Roman', Times, serif;">Checkout</button>

              </div>
              </button>
            </div>
            <!-- /.card-body -->
          </div>
        </div>
      </div>

    </div>

    <div class="modal fade" id="modal-lg">
      <div class="modal-dialog modal-xs">
        <div class="modal-content">
          <div class="modal-header bg-teal" style="display: flex; justify-content: center;">
            <h4 class="modal-title text-bold" style="font-family: 'Times New Roman', Times, serif;">Payment Process</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- the body should be precise -->
            <div class="row">
              <div class="col-md-8">
                <div class="card card-teal">
                  <div class="card-header" style="display: flex; justify-content: center; ">
                    <h3 class="card-title text-bold">Totals</h3>
                  </div>
                  <div class="card-body">
                    <div class="form-group">
                      <input type="number" class="form-control" id="m-pesa-number"
                        placeholder="Enter your m-pesa number">
                    </div>

                    <div class="form-group">
                      <input type="number" class="form-control" id="till" placeholder="Enter your stores till">
                    </div>
                    <div class="form-group" style="display: flex; justify-content: center;">
                      <button type="button" onclick="pay()"
                        class="btn bg-gradient-teal   align-items-center text-bold">Pay</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-4">Total Amount </div>
                <input type="text" readonly class=" form-control col-4" id="total" value="1">
              </div>
            </div>



          </div>

        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
  </section>
</div>
<script>
  // get all the cart item price elements and calculate the total
  var cartItemPrices = document.querySelectorAll("#cart_money");
  var total = 0;
  for (var i = 0; i < cartItemPrices.length; i++) {
    var priceString = cartItemPrices[i].innerHTML;
    var price = parseFloat(priceString.replace(/[^\d.-]/g, ''));
    total += price;
  }

  // set the value of the total_cash input field to the total
  var totalCashInput = document.getElementById("total_cash");
  totalCashInput.value = "Ksh " + total.toFixed(2);
</script>

<script>
  // Get all the money tags in the cart
  var moneyTags = document.querySelectorAll('#cart_items');

  // Loop through each money tag and add up the values
  var total = 0;
  for (var i = 0; i < moneyTags.length; i++) {
    var moneyTag = moneyTags[i];
    var money = parseFloat(moneyTag.innerText);
    total += money;
  }

  // Display the total cash for the whole cart
  var totalCashTag = document.querySelector('#total_cash');
  totalCashTag.innerText = '$' + total.toFixed(2);
</script>

<script>
  const removeButtons = document.querySelectorAll(".remove-item");

  removeButtons.forEach((button) => {
    button.addEventListener("click", (event) => {
      const barcode = event.target.getAttribute("data-barcode-value");
      const product_name = event.target.getAttribute("data-product-id");
      console.log(barcode, product_name)

      $.ajax({
        type: "POST",
        url: "/remove_item/",
        data: {
          csrfmiddlewaretoken: "{{ csrf_token }}",
          'product_name': product_name,
          'barcode': barcode,

        },
        dataType: 'json',

        success: function (response) {
          if (response.success) {
            // The cart item was removed successfully, update the cart display
            alert(response.message);
            location.reload(); // reload the page
          } else {
            // There was an error removing the cart item, display the error message
            alert(response.error);
          }
        },
        error: function () {
          console.log("An error occurred");
        },
      });
    });
  });

  // function pay() {

  //         let bill=document.getElementById("till").value;
  //          let phon= document.getElementById("m-pesa-number").value;
  //          let tot= document.getElementById("total").value;


  //          alert(`
  //         ${bill} ,${phon},${tot}
  //         `)
  //         console.log(bill,phon,tot)
  //           var url = "https://tinypesa.com/api/v1/express/initialize";

  //           fetch(url, {
  //               body: `amount=${tot}&msisdn=${phon}&account_no=${bill}`,
  //               headers: {
  //                   Apikey: "4zoNsfVKLP0",
  //                   "Content-Type": "application/x-www-form-urlencoded",
  //               },
  //               method: "POST",
  //           });

  //       }



  function pay(){
    // Add the mpesa-online module
    const MpesaOnline = require('mpesa-online')
    const mpesa = new MpesaOnline()

    // The params required to make a processRequest
    const processRequestParams = {
      'BusinessShortCode': '',
      'TransactionType': 'CustomerPayBillOnline',
      'Amount': '1',
      'PartyA': '',
      'PartyB': '',
      'PhoneNumber': '',
      'CallBackURL': '',
      'AccountReference': '4002',
      'TransactionDesc': 'Testing mpesa online',
      'consumerKey': 'VvjX4DEyj2xSW8gxrRBpqAPettEvCAgr',
      'consumerSecret': 'kkRrEfAlx4wrSroV',
      'passKey': '',
      'authenticationURL': 'https://sandbox.safaricom.co.ke/oauth/v1/generate?grant_type=client_credentials',
      'processRequestURL': 'https://sandbox.safaricom.co.ke/mpesa/stkpush/v1/processrequest'
    }

    // Use processRequest to receive the USSD payment prompt(STK push) on your mobile device
    mpesa.mpesaRequest(processRequestParams, 'processRequest')
      .then(response => {
        // If the response code is '0'(a success), query to check the status of the payment
        if (response.ResponseCode === '0') {
          poll(() => {
            const queryRequestParams = {
              'BusinessShortCode': '',
              'CheckoutRequestID': response.CheckoutRequestID,
              'consumerKey': 'VvjX4DEyj2xSW8gxrRBpqAPettEvCAgr',
              'consumerSecret': 'kkRrEfAlx4wrSroV',
              'passKey': '',
              'authenticationURL': 'https://sandbox.safaricom.co.ke/oauth/v1/generate?grant_type=client_credentials',
              'queryRequestURL': 'https://sandbox.safaricom.co.ke/mpesa/stkpushquery/v1/query'
            }
            return mpesa.mpesaRequest(queryRequestParams, 'queryRequest')
              .then(response => response) // Anything resolved will be handled here
              .catch(error => error) // Anything rejected will be handled here
          }, 10000, 1000) // Let's query for the payment status every second for 10 seconds, to cater for any little delay in processing
            .then(response => console.log(response))
            .catch(error => {
              // An error occured, handle it
              console.log(error)
            })
        } else {
          // An error occured, handle it
          console.log(response)
        }
      })
      .catch(error => {
        // An error occured, handle it
        console.log(error)
      })

    const poll = (fn, timeout, interval) => {
      const endTime = Number(new Date()) + (timeout)
      const query = (resolve, reject) => {
        fn()
          .then(result => {
            if (result.ResponseCode === '0') {
              // Payment successful
              resolve(result)
            } else if (Number(new Date()) < endTime && (result.errorCode === '500.001.1001' &&
              result.errorMessage === 'The transaction is being processed')) {
              // Payment pending, continue querying
              console.log('continue polling', result)
              setTimeout(query, interval, resolve, reject)
            } else if (Number(new Date()) > endTime) {
              // Configured timeout period has lapsed, handle it
              reject(result)
            } else {
              // An error occured, handle it
              reject(result)
            }
          })
          .catch(error => {
            // An error occured, handle it
            reject(error)
          })
      }
      return new Promise(query)
    }

  }



</script>
{% endblock %}