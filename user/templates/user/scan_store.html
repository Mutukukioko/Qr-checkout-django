{% extends "user/base.html" %}
{% load static %}
{% block title %}
Scan Store
{% endblock %}
{% block content %}

<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content">
        <div class="container-fluid">
            <br>
            <br>
            <div class="row">
                <div id="scan-area">
                    <video id="video"></video>
                    <canvas id="canvas" style="display:none;"></canvas>
                </div>
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">Add Products</h3>
                    </div>
                    {% csrf_token %}
                    <form id="scan-form" method="post" class="col-md-8">

                        <div class="form-group">
                            <label for="{{ form.name.id_for_label }}">Store name:</label>
                            <div class="input-group">
                                {{ form.name }}
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="{{ form.barcode.id_for_label }}">Store Qr:</label>
                            <div class="input-group">
                                {{ form.barcode }}
                            </div>

                <button id="start-scan-button">Start Scan</button>
                <button id="stop-scan-button">Stop Scan</button>
                        </div>

                        
                        <button type="submit">Submit</button>

                    </form>
                </div>
            </div>
         
        </div>

        <script>
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const scanArea = document.getElementById('scan-area');
            const barcodeInput = document.getElementById('barcode-input');
            const startScanButton = document.getElementById('start-scan-button');

            const stopScanButton = document.getElementById('stop-scan-button');

            let scanInterval;

            const startScan = () => {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then((stream) => {
                        video.srcObject = stream;
                        video.play();
                        stopScanButton.style.display = 'block';
                        startScanButton.style.display = 'none';
                        scanInterval = setInterval(scan, 100);
                    })
                    .catch((error) => {
                        console.error('Unable to access the camera.', error);
                    });
            };

            const stopScan = () => {
                clearInterval(scanInterval);
                video.srcObject.getTracks().forEach(track => track.stop());
                startScanButton.style.display = 'block';
                scanArea.style.display = 'none';
            };

            const scan = () => {
                const width = video.videoWidth;
                const height = video.videoHeight;
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, width, height);
                const imageData = ctx.getImageData(0, 0, width, height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) {
                    console.log('Barcode value:', code.data);
                    //  update barcode tag value
                    barcodeInput.value = code.data;
                    // barcodeTag.innerText = code.data;
                    scanArea.style.display = 'none';
                    stopScan();

                }
            }

            startScanButton.addEventListener('click', startScan);
            stopScanButton.addEventListener('click', stopScan);


        </script>

</div>
</section>


{% endblock %}